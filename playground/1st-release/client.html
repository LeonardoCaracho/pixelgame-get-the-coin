<html>
    <head>
        <meta charset="utf-8">
        <title> Get the coin! </title>

        <style>
            #screen {
                border: 1px solid gray;
                image-rendering: pixelated;
                image-rendering: crisp-edges;
                image-rendering: -moz-crisp-edges;
                width: 400px;
                height: 400px;
            }
        </style>
        <script src="keyboard-listener.js"></script>
    </head>
    <body>
        <canvas id="screen" width="10" height="10"></canvas>
    </body>
</html>

<script>
    const screen = document.getElementById('screen')
    const context = screen.getContext('2d')
    const currentPlayerId = 'player1'
    
    
    function createGame(){ 

        const state = {
            players: {},
            coins: {}
        }

        function addPlayer(command){
            const playerId = command.playerId
            const playerX = command.playerX
            const playerY = command.playerY

            state.players[playerId] = {
                x: playerX,
                y: playerY
            }
        }

        function removePlayer(command){
            const playerId = command.playerId
            delete state.players[playerId]
        }

        function addCoin(command){
            const coinId = command.coinId
            const coinX = command.coinX
            const coinY = command.coinY

            state.coins[coinId] = {
                x: coinX,
                y: coinY
            }
        }

        function removeCoin(command){
            const coinId = command.coinId
            delete state.coins[coinId]
        }

        //factory pattern
        function movePlayer(command){
            console.log(`Moving ${command.playerId} with ${command.keyPressed}`)

            const acceptedMoves = {
                ArrowUp(player){
                    if (player.y - 1 >= 0){
                        player.y = player.y  - 1
                    }
                },
                ArrowRight(player){
                    if (player.x + 1 < screen.width){
                        player.x = player.x + 1
                    }
                },
                ArrowDown(player){
                    if (player.y + 1 < screen.height){
                        player.y = player.y + 1
                    }
                },
                ArrowLeft(player){
                    if (player.x - 1 >= 0){
                        player.x = player.x - 1
                    }
                }
            }

            const keyPressed = command.keyPressed
            const playerId = command.playerId
            const player = state.players[command.playerId]
            const moveFunction = acceptedMoves[keyPressed]
            
            if (player && moveFunction){
                moveFunction(player)
                checkCoinForCollision(playerId)
            }

        }

        function checkCoinForCollision(playerId){
            const player = state.players[playerId]

            for (coinId in state.coins){
                const coin = state.coins[coinId]
                
                if (player.x == coin.x && player.y == coin.y)
                    removeCoin({ coinId: coinId })
            }
        }

        return {
            addPlayer,
            removePlayer,
            addCoin,
            removeCoin,
            movePlayer,
            state
        }
    }

    const game = createGame()
    const keyboardListener = createKeyboardListener()
    game.addPlayer({ playerId: 'player1', playerX: 1, playerY: 1  })
    game.addCoin({ coinId: 'coin1', coinX: 5, coinY: 5  })
    keyboardListener.subscribe(game.movePlayer)

    renderScreen()


    function renderScreen(){

        context.clearRect(0, 0, 10, 10)

        for (const playerId in game.state.players){
            const player = game.state.players[playerId]
            context.fillStyle = 'black'
            context.fillRect(player.x, player.y, 1, 1)
        }

        for (const coinId in game.state.coins){
            const coin = game.state.coins[coinId]
            context.fillStyle = 'yellow'
            context.fillRect(coin.x, coin.y, 1, 1)
        }

        requestAnimationFrame(renderScreen)
    }

</script>